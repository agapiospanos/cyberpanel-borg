# CyberPanel Borg Backup
This is a series of bash scripts that allow for a customized borg backup of the databases, domains and emails that are managed by the [CyberPanel](https://cyberpanel.net/) open-source web hosting panel.

# Motivation - What does this project try to solve
I liked cyberpanel and I wanted to have more control over the backup / restore procedure.
This project offers basic features that I was missing from the cyberpanel backup implementation and they are really important for me!
1. Backup and restore child domains of a website individually (e.g. what would happen if you wanted to restore only a child domain? Via cyberpanel you only get the option to restore the whole websites' data)
2. Backup and restore email accounts of a website individually instead of restoring all accounts at once.
3. Configurable ssh location for backups with support for Hetzner storageboxes that I love to use. Btw, if you would like to try Hetzner Cloud here is [my referral link](https://hetzner.cloud/?ref=6L5jCPv0bcf5). When you sign up for their cloud services you will receive â‚¬20 in cloud credits. (StorageBox is not part of the cloud service but VMs are ðŸ˜‰ )
4. Email report for the automated backup. The email reports if there are any failed backups (domains/databases/emails) and checks for the remaining disk space on the backup destination afterwards. If the space is below the defined threshold (90% by default - see config.sh.template) you will get notified. NOTE: The low disk space will not prevent the next backups. So please take action to avoid messing the next backup job.

# What this project does NOT offer
1. A simple to use UI. The backup restore scripts are not accessible from the Cyberpanel UI but only via terminal. I am not aware of how I can embed them (not a python expert ðŸ˜‡) and I will not go through the effort anytime soon. (Contributors that can implement that are of course welcome to create a pull request)

# Prerequisites
1. Install borg. Details here: [Borg Install Docs](https://borgbackup.readthedocs.io/en/stable/installation.html)
2. Install mailx (optional: Only if you want to be able to receive email reports after the automated backup is executed). Details here: [Install mailx command](https://www.atechtown.com/install-mailx-on-linux/#install-mailx-on-linux)

# Installation
### **1. Get the scripts**
The recommended way to install this set of scripts is to use git to clone the repo to your server. This will make it easier for you to install the updates by just using the git pull command later. So, to get started just clone this repo using
```bash
git clone https://github.com/agapiospanos/cyberpanel-borg.git
```

<br/>

### **2. Prepare the configuration**
You have to create the config.sh file from the config.sh.template file. Note that whenever you update the script using git pull the config.sh file will not be overwritten. Thus, your configuration will not be affected. ðŸ˜‰
<br/>
Please read carefully that config file and change whatever you need to make it tailored to your needs. There are 2 options for the configuration. You can either use a local backup destination or an ssh destination (remote backup server). I would definitely suggest to use a remote server since keeping backup at the same server is not wise at all...

#### **2.1 Backup location**

1. Using a local backup dir
<br/>
You just have to remove the value from SSH_ related variables. Make them have an empty value like below.
Then you have to specify the backup directory. Please DON'T add a trailing slash in the end. If you leave the default value like below it will just create a /backups/yourservername folder in the root of your server.

```bash
SSH_HOST=
SSH_USER=
SSH_PORT=
SSH_DESTINATION=

BACKUP_DIR=/backups/yourservername
```

<br/>

2. Using an ssh backup destination
First make sure that you can connect to the remote server using your public key (without password). If you are using Hetzner storageboxes take a look here [Hetzner StorageBox ssh keys](https://docs.hetzner.com/robot/storage-box/backup-space-ssh-keys/). If you have a custom ssh server you just have to add your id_rsa.pub (or whatever your public ssh key is) to .ssh/authorized_keys file of your ssh server. The config template has an example config for Hetzner StorageBox. For the ssh config (either hetzner or your own ssh server), you just have to update SSH_HOST, SSH_USER and SSH_PORT. You don't have to update SSH_DESTINATION since it is generated by the other ssh variables. The BACKUP_DIR has to be absolute path (having the / in the beginning).
```bash
SSH_HOST=u123456.your-storagebox.de
SSH_USER=u123456
SSH_PORT=23
SSH_DESTINATION="ssh://$SSH_USER@$SSH_HOST:$SSH_PORT/."

BACKUP_DIR=/backups/yourservername
```

<br/>

#### **2.2 Email Reports**
If you want to receive email reports when the automated backup (cron-run-backup-job.sh) is executed you have to specify the email variables in the config.sh file. Important! Make sure that the EMAIL_FROM_EMAIL variable is set to domain that your server has permission to send messages from (spf, dkim, ptr records should be configured properly). If you choose a domain that CyberPanel controls in the server that this script runs on then you should be ok. Just pick a domain that CyberPanel has email functionality enabled. The specific email account that sends the email doesn't have to exist. (e.g. server@domain.com)

```bash
ADMIN_EMAIL=youremail@domain.com
EMAIL_FROM_NAME=YourServerName
EMAIL_FROM_EMAIL=server@yourdomain.com
```

<br/>

#### **2.3 Backup Retention**
You have to specify how many backups should be kept. This is important to avoid having your backup space cluttered. The default config is keeping probably too many backups (90 days and 24 weeks). Borg docs can help you pick the right values for your use case. [(Borg prune examples)](https://borgbackup.readthedocs.io/en/stable/usage/prune.html?highlight=prune#examples)
```bash
BACKUP_DAYS=90
BACKUP_WEEKS=24
BACKUP_MONTHS=-1
```

<br/>

#### **2.4 Encryption key**
One of the most important config values! You definitely have to change that something that only you know. It's really important to remember the passphrase if you want to restore a backup. Otherwise your backups are gone forever! Please do not change this value if you have already taken some backups with the script. Otherwise the functionality might be broken. So it is really important to configure this NOW, before taking any backup! Also, please do not remove the "export" in front of the variable. Otherwise borg will not have access to that.
```bash
export BORG_PASSPHRASE="change_me_to_a_secret_value"
```

<br/>

### **3. (optional) Configure the excluded files and test configuration**
You can configure files or directories to be excluded from the backup. This makes sense for cache files for example. Avoiding the cache files can significantly reduce the storage space required for the backups. Check the backup-file-exclude.lst file. By default the wordpress cache files are excluded. 
<br/>

You can test the configuration of that file against a domain or child domain files that you have. You can run the following command to get the list of excluded files for a specific domain.
```bash
bash test-file-exclude.sh your-domain.com
```

<br/>

### **4. (optional) Check if the email functionality works**
You can quickly check if the notification emails are working. This only applies if you have configured the email variables in the config.sh file as shown above. To test the functionality run
```bash
bash test-email.sh
```

<br/>

# Usage

## **Automated Backup Job**

<br/>

### **Cron Job Backup**
Edit the crontab of the root user
```bash
crontab -e
```
Add the following record to take a backup daily at midnight (00:00). You can use the [crontab-generator online tool](https://crontab-generator.org/) to create your own cron schedule if our suggestion doesn't fit for you.
```bash
0 0 * * * /bin/bash /path/to/this/project/cron-run-backup-job.sh >/dev/null 2>&1
```
Please note that the current implementation allows only 1 run per day. However, you don't have to run the job daily if you don't want to (for example if you want to take weekly backups).

<br/>
<br/>

## **Backup Jobs**

<br/>

### **Backup domain**
```bash
bash backup-domain.sh mydomain.com
```
Note: Backing up a domain (website) doesn't automatically backup its child domains. This is intentional to give more control to you. You can backup a child domain of a website using the command below.
```bash
bash backup-domain.sh mychilddomain.mydomain.com
``` 

<br/>

### **Backup database**
```bash
bash backup-database.sh my_database_name
```

<br/>

### **Backup email**

```bash
bash backup-email.sh info@mydomain.com
```
<br/>
<br/>

## **Restore Jobs**

<br/>

### **Restore domain**
```bash
bash restore-domain.sh mydomain.com 2021-10-25
```
Note: Restoring a domain (website) doesn't automatically restore its child domains. This is intentional to give more control to you. You can restore a child domain of a website using the command below.
```bash
bash restore-domain.sh mychilddomain.mydomain.com 2021-10-25
``` 

<br/>

### **Restore database**
```bash
bash restore-database.sh my_database_name 2021-10-25
```

<br/>

### **Restore email**

```bash
bash restore-email.sh info@mydomain.com 2021-10-25
```
<br/>
<br/>

## **Export Backup Jobs**

<br/>

### **Export domain**
```bash
bash export-domain.sh mydomain.com 2021-10-25
```
Note: Exporting a domain (website) doesn't automatically export its child domains. This is intentional to give more control to you. You can export a child domain of a website using the command below.
```bash
bash export-domain.sh mychilddomain.mydomain.com 2021-10-25
``` 

<br/>

### **Export database**
```bash
bash export-database.sh my_database_name 2021-10-25
```

<br/>

### **Export email**

```bash
bash export-email.sh info@mydomain.com 2021-10-25
```
<br/>

# Ideas for future features
- Add scripts to perform backups to /etc and config files of cyberpanel
- Take into account suspended users and websites. (Do not perform automated backups for suspended users/websites and move their backups to an "archive" folder)
- Add support for local backup exports. (Currently the exported tar.gz backup files are stored in the remote SSH location if you use remote backups.)

# Limitations
The only known limitation is that you cannot restore a db / domain / email if that doesn't exist in cyberpanel. You have to create first the db / domain / email that you want to restore if that doesn't exist in the panel. I have taken into account this cases and the scripts will show a message to warn you.

# Disclaimer
This is personal project to help me better handle the backups of my cyberpanel server. I don't guarantee that the scripts work as intended, nor do I hold any responsibility if the scripts cause any data loss or if the backups taken with it don't work properly. Use it under your own responsibility and let me know if there are any issues using the GitHub issues section.

# Acknowledgements
This project was inspired by the [vestacp-borg-incremental-backups](https://github.com/ramirojoaquin/vestacp-borg-incremental-backups) project and I would like to thank the developer of that scripts for his work.
